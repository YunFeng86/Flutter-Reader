name: Release Build

on:
  push:
    tags:
      - 'v*'  # è§¦å‘æ¡ä»¶: æ‰€æœ‰vå¼€å¤´çš„tag (v0.0.1, v1.0.0-alpha, v1.2.3-beta.1, v2.0.0-rc.2ç­‰)
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘ï¼ˆæµ‹è¯•CIç”¨ï¼‰

jobs:
  # è·¨å¹³å°æ„å»ºï¼ˆä½¿ç”¨çŸ©é˜µç­–ç•¥æ¶ˆé™¤é‡å¤ä»£ç ï¼‰
  build:
    timeout-minutes: 30  # é˜²æ­¢æ„å»ºå¡æ­»æµªè´¹Actionsåˆ†é’Ÿæ•°
    strategy:
      fail-fast: false  # ä¸€ä¸ªå¹³å°å¤±è´¥ä¸å½±å“å…¶ä»–å¹³å°ç»§ç»­æ„å»º
      matrix:
        include:
          # Windowsæ„å»ºï¼ˆæ­£å¼æ”¯æŒï¼Œå·²æµ‹è¯•ï¼‰
          - os: windows-latest
            platform: windows
            build-args: windows --release
            artifact-path: build/windows/x64/runner/Release
            artifact-name: fleur-windows-x64.zip
            archive-cmd: |
              cd build/windows/x64/runner/Release
              rm -f *.pdb
              7z a -tzip "$GITHUB_WORKSPACE/fleur-windows-x64.zip" *

          # macOSæ„å»ºï¼ˆå®éªŒæ€§ï¼Œæœªæµ‹è¯•ï¼‰
          - os: macos-latest
            platform: macos
            build-args: macos --release
            artifact-path: build/macos/Build/Products/Release
            artifact-name: fleur-macos.zip
            archive-cmd: |
              cd build/macos/Build/Products/Release
              zip -r "$GITHUB_WORKSPACE/fleur-macos.zip" Fleur.app

          # Linuxæ„å»ºï¼ˆå®éªŒæ€§ï¼Œæœªæµ‹è¯•ï¼‰
          - os: ubuntu-latest
            platform: linux
            build-args: linux --release
            artifact-path: build/linux/x64/release/bundle
            artifact-name: fleur-linux-x64.tar.gz
            archive-cmd: |
              cd build/linux/x64/release/bundle
              tar -czf "$GITHUB_WORKSPACE/fleur-linux-x64.tar.gz" *
            deps-cmd: sudo apt-get update && sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Linuxå¹³å°éœ€è¦é¢å¤–å®‰è£…ä¾èµ–
      - name: Install platform dependencies
        if: matrix.deps-cmd
        run: ${{ matrix.deps-cmd }}

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.5'  # åŒ¹é…æœ¬åœ°å¼€å‘ç¯å¢ƒï¼ˆè‡ªå¸¦Dart 3.10.4ï¼‰
          channel: 'stable'
          cache: true  # å¯ç”¨Flutter SDKç¼“å­˜ï¼ŒåŠ é€Ÿåç»­æ„å»º

      # ç¼“å­˜pubä¾èµ–ï¼Œé¿å…æ¯æ¬¡é‡æ–°ä¸‹è½½
      - name: Cache pub dependencies
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.PUB_CACHE }}
            ~/.pub-cache
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-

      - name: Install dependencies
        run: flutter pub get

      # è®¡ç®—ç‰ˆæœ¬å˜é‡ï¼ˆç‰ˆæœ¬å·+æ„å»ºå·+Commit Hashï¼‰
      - name: Calculate version variables
        id: version_vars
        shell: bash
        run: |
          # æå–ç‰ˆæœ¬å·ï¼ˆä»tagç§»é™¤vå‰ç¼€ï¼Œå¦‚ v1.0.0-alpha.1 -> 1.0.0-alpha.1ï¼‰
          VERSION_NAME="${{ github.ref_name }}"
          VERSION_NAME=${VERSION_NAME#v}

          # æ„å»ºå·ï¼šä½¿ç”¨GitHub Actionsçš„run_numberï¼ˆçº¯æ•°å­—ï¼Œä¸¥æ ¼é€’å¢ï¼‰
          BUILD_NUM=${{ github.run_number }}

          # å®Œæ•´ç‰ˆæœ¬å·ï¼ˆç¬¦åˆè¯­ä¹‰åŒ–ç‰ˆæœ¬è§„èŒƒï¼‰
          FULL_VERSION="${VERSION_NAME}+${BUILD_NUM}"

          # Git Commit Hashï¼ˆç”¨äº"å…³äº"é¡µé¢æ˜¾ç¤ºï¼Œä¸å†™å…¥pubspec.yamlï¼‰
          COMMIT_HASH=$(git rev-parse --short HEAD)

          # æ„å»ºæ—¶é—´ï¼ˆUTCï¼‰
          BUILD_TIME=$(date -u "+%Y-%m-%d %H:%M UTC")

          # è¾“å‡ºå˜é‡ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "build_number=$BUILD_NUM" >> $GITHUB_OUTPUT
          echo "full_version=$FULL_VERSION" >> $GITHUB_OUTPUT
          echo "commit_hash=$COMMIT_HASH" >> $GITHUB_OUTPUT
          echo "build_time=$BUILD_TIME" >> $GITHUB_OUTPUT

          # è°ƒè¯•è¾“å‡º
          echo "âœ… Version: $FULL_VERSION"
          echo "âœ… Commit: $COMMIT_HASH"
          echo "âœ… Build Time: $BUILD_TIME"

      # æ›´æ–°pubspec.yamlçš„ç‰ˆæœ¬å·ï¼ˆä»…åœ¨tagæ„å»ºæ—¶ï¼‰
      - name: Update version from tag
        if: startsWith(github.ref, 'refs/tags/')
        shell: bash
        run: |
          VERSION="${{ steps.version_vars.outputs.full_version }}"

          # ä½¿ç”¨sedæ›¿æ¢pubspec.yamlä¸­çš„ç‰ˆæœ¬å·ï¼ˆå¤„ç†macOS/Linuxçš„sedå·®å¼‚ï¼‰
          if [[ "$RUNNER_OS" == "macOS" ]]; then
            sed -i '' "s/^version: .*/version: $VERSION/" pubspec.yaml
          else
            sed -i "s/^version: .*/version: $VERSION/" pubspec.yaml
          fi

          echo "âœ… Updated pubspec.yaml version to $VERSION"
          grep "^version:" pubspec.yaml

      - name: Generate Isar code
        run: dart run build_runner build --delete-conflicting-outputs

      # è¿è¡Œæµ‹è¯•ï¼ˆå¯é€‰ï¼šå¦‚æœæµ‹è¯•å¤±è´¥åˆ™ä¸å‘å¸ƒï¼‰
      - name: Run tests
        run: flutter test
        continue-on-error: true  # æµ‹è¯•å¤±è´¥ä¸é˜»å¡æ„å»ºï¼ˆAlphaç‰ˆæœ¬å®¹å¿æµ‹è¯•å¤±è´¥ï¼‰

      - name: Build ${{ matrix.platform }} release
        shell: bash
        run: |
          flutter build ${{ matrix.build-args }} \
            --dart-define=APP_COMMIT_HASH="${{ steps.version_vars.outputs.commit_hash }}" \
            --dart-define=APP_BUILD_TIME="${{ steps.version_vars.outputs.build_time }}" \
            --dart-define=APP_BUILD_NUMBER="${{ steps.version_vars.outputs.build_number }}"

      - name: Archive build artifacts
        shell: bash
        run: ${{ matrix.archive-cmd }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.platform }}-release
          path: ${{ matrix.artifact-name }}
          retention-days: 90  # ä¿ç•™90å¤©

  # Windows å®‰è£…å™¨æ„å»º
  build-windows-installer:
    needs: [build]
    runs-on: windows-latest
    timeout-minutes: 20  # æ·»åŠ è¶…æ—¶ä¿æŠ¤
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: windows-release
          path: windows-release

      - name: Extract Windows build
        shell: powershell
        run: |
          # æ£€æŸ¥ä¸‹è½½çš„æ–‡ä»¶
          Write-Host "Downloaded artifacts:"
          Get-ChildItem -Path "windows-release" -File | ForEach-Object { Write-Host "  $($_.Name) - $($_.Length) bytes" }
          
          cd windows-release
          # ä½¿ç”¨ PowerShell çš„ Expand-Archive è€Œä¸æ˜¯ 7z
          Expand-Archive -Path "fleur-windows-x64.zip" -DestinationPath "temp" -Force
          
          Write-Host "Extracted files:"
          Get-ChildItem -Path "temp" -Recurse | ForEach-Object { Write-Host "  $($_.FullName)" }
          
          # æ£€æŸ¥å…³é”®æ–‡ä»¶
          if (Test-Path "temp\fleur.exe") {
            Write-Host "Main executable found"
          } else {
            Write-Error "Main executable not found!"
            exit 1
          }

      # è®¡ç®—ç‰ˆæœ¬å˜é‡
      - name: Calculate version variables
        id: version_vars
        shell: bash
        run: |
          VERSION_NAME="${{ github.ref_name }}"
          VERSION_NAME=${VERSION_NAME#v}
          echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT

      # ä½¿ç”¨ Inno Setup åˆ›å»ºå®‰è£…å™¨
      - name: Build Windows Installer
        shell: powershell
        run: |
          # å…ˆæ£€æŸ¥æ–‡ä»¶ç»“æ„
          Write-Host "Checking file structure:"
          Get-ChildItem -Path "windows-release\temp" -Recurse | Select-Object FullName | ForEach-Object { Write-Host $_.FullName }
          
          # æ£€æŸ¥å¹¶åˆ›å»ºå¿…è¦æ–‡ä»¶
          if (-not (Test-Path "LICENSE")) {
            Write-Host "Creating LICENSE file"
            "MIT License" | Out-File -FilePath "LICENSE" -Encoding UTF8
          }
          
          # åˆ›å»º Inno Setup è„šæœ¬ - ç®€åŒ–ç‰ˆæœ¬ï¼Œé¿å…å¤æ‚è·¯å¾„é—®é¢˜
          $issContent = @"
          [Setup]
          AppName=Fleur
          AppVersion=${{ steps.version_vars.outputs.version_name }}
          AppPublisher=Fleur Team
          AppPublisherURL=https://github.com/${{ github.repository }}
          AppSupportURL=https://github.com/${{ github.repository }}/issues
          AppUpdatesURL=https://github.com/${{ github.repository }}/releases
          DefaultDirName={autopf}\Fleur
          DefaultGroupName=Fleur
          AllowNoIcons=yes
          LicenseFile=LICENSE
          OutputBaseFilename=fleur-windows-x64-installer-${{ steps.version_vars.outputs.version_name }}
          SetupIconFile=windows\runner\resources\app_icon.ico
          Compression=lzma
          SolidCompression=yes
          WizardStyle=modern
          ArchitecturesAllowed=x64
          ArchitecturesInstallIn64BitMode=x64
          MinVersion=10.0
          PrivilegesRequired=lowest
          
          [Languages]
          Name: "english"; MessagesFile: "compiler:Default.isl"
          
          [Tasks]
          Name: "desktopicon"; Description: "{cm:CreateDesktopIcon}"; GroupDescription: "{cm:AdditionalIcons}"
          
          [Files]
          Source: "windows-release\temp\*"; DestDir: "{app}"; Flags: ignoreversion recursesubdirs createallsubdirs
          
          [Icons]
          Name: "{group}\Fleur"; Filename: "{app}\fleur.exe"
          Name: "{group}\{cm:UninstallProgram,Fleur}"; Filename: "{uninstallexe}"
          Name: "{autodesktop}\Fleur"; Filename: "{app}\fleur.exe"; Tasks: desktopicon
          
          [Run]
          Filename: "{app}\fleur.exe"; Description: "{cm:LaunchProgram,Fleur}"; Flags: nowait postinstall skipifsilent
          "@
          
          $issContent | Out-File -FilePath "installer.iss" -Encoding UTF8
          Write-Host "Created installer.iss"

      - name: Install Inno Setup and Compile Installer
        uses: Minionguyjpro/Inno-Setup-Action@v1.2.4
        with:
          path: installer.iss
          options: /Qp

      - name: Check generated installer
        shell: powershell
        run: |
          Write-Host "=== Current working directory ==="
          Write-Host "PWD: $(Get-Location)"
          
          Write-Host "`n=== All files in current directory ==="
          Get-ChildItem -Path "." -File | ForEach-Object {
            Write-Host "File: $($_.Name) ($([math]::Round($_.Length / 1MB, 2)) MB)"
          }
          
          Write-Host "`n=== Checking Output directory ==="
          if (Test-Path "Output") {
            Write-Host "Output folder exists, contents:"
            Get-ChildItem -Path "Output" -File | ForEach-Object {
              Write-Host "  Output/$($_.Name) ($([math]::Round($_.Length / 1MB, 2)) MB)"
            }
          } else {
            Write-Host "No Output folder found"
          }
          
          Write-Host "`n=== Checking installer.iss content ==="
          if (Test-Path "installer.iss") {
            Write-Host "installer.iss exists, showing OutputBaseFilename line:"
            Get-Content "installer.iss" | Where-Object { $_ -like "*OutputBaseFilename*" }
          } else {
            Write-Host "installer.iss not found!"
          }
          
          Write-Host "`n=== Checking windows-release extraction ==="
          if (Test-Path "windows-release\temp") {
            Write-Host "windows-release\temp exists:"
            Get-ChildItem -Path "windows-release\temp" -File | ForEach-Object {
              Write-Host "  $($_.Name)"
            }
          } else {
            Write-Host "windows-release\temp not found!"
          }

      - name: Upload Windows Installer
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: Output/fleur-windows-x64-installer-*.exe
          retention-days: 90
          if-no-files-found: error

  # åˆ›å»ºGitHub Releaseå¹¶ä¸Šä¼ æ‰€æœ‰æ„å»ºäº§ç‰©
  create-release:
    needs: [build, build-windows-installer]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Determine if prerelease
        id: prerelease
        run: |
          TAG="${{ github.ref_name }}"
          if [[ "$TAG" =~ -alpha|-beta|-rc ]]; then
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
            echo "version_type=é¢„å‘å¸ƒç‰ˆæœ¬" >> $GITHUB_OUTPUT
          else
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
            echo "version_type=æ­£å¼ç‰ˆæœ¬" >> $GITHUB_OUTPUT
          fi

      # é‡å‘½åartifactæ–‡ä»¶ä»¥åŒ…å«ç‰ˆæœ¬å·
      - name: Rename artifacts with version
        run: |
          VERSION="${{ github.ref_name }}"
          VERSION=${VERSION#v}

          # é‡å‘½åWindowsæ„å»º
          if [ -f artifacts/windows-release/fleur-windows-x64.zip ]; then
            mv artifacts/windows-release/fleur-windows-x64.zip \
               artifacts/windows-release/fleur-windows-x64-${VERSION}.zip
          fi

          # é‡å‘½åWindowså®‰è£…å™¨ï¼ˆä¸éœ€è¦é‡å‘½åï¼ŒInno Setupå·²ç»åŒ…å«äº†ç‰ˆæœ¬å·ï¼‰
          # Windows å®‰è£…å™¨å·²ç»åœ¨æ„å»ºæ—¶åŒ…å«ç‰ˆæœ¬å·
          
          # é‡å‘½åmacOSæ„å»º
          if [ -f artifacts/macos-release/fleur-macos.zip ]; then
            mv artifacts/macos-release/fleur-macos.zip \
               artifacts/macos-release/fleur-macos-${VERSION}.zip
          fi

          # é‡å‘½åLinuxæ„å»º
          if [ -f artifacts/linux-release/fleur-linux-x64.tar.gz ]; then
            mv artifacts/linux-release/fleur-linux-x64.tar.gz \
               artifacts/linux-release/fleur-linux-x64-${VERSION}.tar.gz
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          draft: false
          prerelease: ${{ steps.prerelease.outputs.is_prerelease }}
          generate_release_notes: true
          body: |
            ## æ”¯æŒå¹³å°

            ### âœ… æ­£å¼æ”¯æŒï¼ˆå·²æµ‹è¯•ï¼‰
            - **Windows 10/11 (x64)** - ç»è¿‡å……åˆ†æµ‹è¯•ï¼Œç¨³å®šå¯ç”¨

            ### ğŸ”„ å®éªŒæ€§æ”¯æŒï¼ˆæœªç»æµ‹è¯•ï¼Œé£é™©è‡ªè´Ÿï¼‰
            - **macOS 11+** - ç†è®ºä¸Šå¯ç”¨ï¼Œä½†æœªåœ¨çœŸæœºéªŒè¯
            - **Linux (x64)** - éœ€è¦ GTK 3.0+ï¼Œå¯èƒ½éœ€è¦æ‰‹åŠ¨å®‰è£…ä¾èµ–

            ## å·²çŸ¥é—®é¢˜
            - åˆ é™¤å¤§è®¢é˜…æºï¼ˆ>1ä¸‡ç¯‡æ–‡ç« ï¼‰æ—¶å¯èƒ½å¡é¡¿
            - æ•°æ®åº“è¿ç§»é€»è¾‘æœªç»è¿‡å®é™…Schemaå˜æ›´æµ‹è¯•
            - macOS/Linuxçš„çª—å£ç®¡ç†å’Œé€šçŸ¥ç³»ç»ŸæœªéªŒè¯

            ## å®‰è£…è¯´æ˜

            **Windows:**
            1. **å®‰è£…å™¨ç‰ˆæœ¬ï¼ˆæ¨èï¼‰**: ä¸‹è½½ `fleur-windows-x64-installer-*.exe`
               - åŒå‡»è¿è¡Œå®‰è£…å™¨ï¼ŒæŒ‰æç¤ºå®‰è£…
               - è‡ªåŠ¨åˆ›å»ºå¼€å§‹èœå•å’Œæ¡Œé¢å¿«æ·æ–¹å¼
               - æ”¯æŒè‡ªåŠ¨å¸è½½
            2. **ä¾¿æºç‰ˆ**: ä¸‹è½½ `fleur-windows-x64.zip`
               - è§£å‹åˆ°ä»»æ„ç›®å½•
               - è¿è¡Œ `fleur.exe`

            **macOS:**
            1. ä¸‹è½½ `fleur-macos.zip`
            2. è§£å‹åæ‹–åŠ¨ `Fleur.app` åˆ°åº”ç”¨ç¨‹åºæ–‡ä»¶å¤¹
            3. é¦–æ¬¡è¿è¡Œéœ€å³é”® â†’ æ‰“å¼€ï¼ˆç»•è¿‡Gatekeeperï¼‰

            **Linux:**
            1. ä¸‹è½½ `fleur-linux-x64.tar.gz`
            2. è§£å‹: `tar -xzf fleur-linux-x64.tar.gz`
            3. è¿è¡Œ: `./fleur`
            4. å¦‚æœç¼ºå°‘ä¾èµ–: `sudo apt install libgtk-3-0` (Debian/Ubuntu)

            ---

            **å¦‚é‡åˆ°é—®é¢˜è¯·æäº¤ [Issue](https://github.com/${{ github.repository }}/issues)**
          files: |
            artifacts/windows-release/fleur-windows-x64-*.zip
            artifacts/windows-installer/fleur-windows-x64-installer-*.exe
            artifacts/macos-release/fleur-macos-*.zip
            artifacts/linux-release/fleur-linux-x64-*.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
